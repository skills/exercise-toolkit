name: Finish Exercise Workflow

on:
  workflow_call:
    inputs:
      issue-url:
        description: "The URL of the issue to update and close"
        required: true
        type: string
      exercise-title:
        description: "The title of the exercise"
        required: false
        type: string
      update-readme-with-congratulations:
        description: "Whether to update the README with a congratulations message"
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  issues: write

env:
  EXERCISE_TOOLKIT_REF: 570a278b342c572229f7fc56ee72ca08e2048670

jobs:
  update_readme:
    name: Update README with congratulations
    runs-on: ubuntu-latest
    if: inputs.update-readme-with-congratulations

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Get response templates
        uses: actions/checkout@v4
        with:
          repository: skills/exercise-toolkit
          path: exercise-toolkit
          ref: ${{ env.EXERCISE_TOOLKIT_REF }}

      - name: Encode socials text
        id: encode-socials-text
        uses: actions/github-script@v7
        env:
          EXERCISE_TITLE: ${{ inputs.exercise-title }}
        with:
          script: |
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            const exerciseTitle = process.env.EXERCISE_TITLE;

            const firstLine = exerciseTitle && exerciseTitle.trim() !== ''
              ? `I just completed the "${exerciseTitle}" GitHub Skills hands-on exercise! ðŸŽ‰`
              : `I just completed a GitHub Skills hands-on exercise! ðŸŽ‰`;

            const socialsText = `${firstLine}

            ${repoUrl}

            #GitHubSkills #OpenSource #GitHubLearn
            `;

            const encodedText = encodeURIComponent(socialsText);
            core.setOutput('encoded-text', encodedText);

      - name: Build congratulations message from template
        id: build-new-readme
        uses: skills/action-text-variables@v3
        with:
          template-file: exercise-toolkit/markdown-templates/readme/exercise-finished.md
          template-vars: |
            login: ${{ github.actor }}
            issue_url: ${{ inputs.issue-url }}
            encoded_socials_text: ${{ steps.encode-socials-text.outputs.encoded-text }}

      - name: Overwrite README
        env:
          README_TEXT: ${{ steps.build-new-readme.outputs.updated-text }}
        run: echo "$README_TEXT" > README.md

      - name: Update README - congratulations
        uses: EndBug/add-and-commit@v9
        with:
          add: "README.md"
          message: "Congratulations!ðŸŽ‰"
          default_author: github_actions

  finish_issue:
    name: Comment and close issue
    runs-on: ubuntu-latest

    steps:
      - name: Get response templates
        uses: actions/checkout@v4
        with:
          repository: skills/exercise-toolkit
          path: exercise-toolkit
          ref: ${{ env.EXERCISE_TOOLKIT_REF }}

      - name: Build message - exercise finished
        id: build-finish-message
        uses: skills/action-text-variables@v3
        with:
          template-file: exercise-toolkit/markdown-templates/step-feedback/exercise-finished.md
          template-vars: |
            login: ${{ github.actor }}
            repo_full_name: ${{ github.repository }}
      - name: Create comment - exercise finished
        run: |
          gh issue comment "${{ inputs.issue-url }}" \
            --body "${{ steps.build-finish-message.outputs.updated-text }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Close issue
        run: gh issue close "${{ inputs.issue-url }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
